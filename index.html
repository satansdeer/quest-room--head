<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
            <link rel="stylesheet" href="{{ static_url("styles.css") }}">
            <link rel="stylesheet" href="static/styles.css">
            <!--<link href='https://fonts.googleapis.com/css?family=Press+Start+2P&subset=latin,cyrillic' rel='stylesheet' type='text/css'>-->
            <script type="text/javascript">
            countdownActive = true;
            progressValue = 100;
            progressStep = .1;
            requestAnimationFrame(progressBarCountDown)
            function WebSocketTest() {
                var messageContainer = document.getElementById("message");
                var progressBar = document.querySelector(".time-left_progress");
                if ("WebSocket" in window) {
                    var id = window.location.search.split("?")[1].split("=")[1]
                    window.ws = new WebSocket("ws://localhost:8888/socket?Id="+id);
                    ws.onopen = function() {
                        messageContainer.innerHTML = "Connected";
                    };
                    ws.onmessage = function (evt) {
                        var received_msg = JSON.parse(evt.data);
                        messageContainer.innerHTML = unescape(received_msg.message);
                        console.log("RECEIVED MESSAGE")
                        resetProgress();
                        if(!countdownActive && received_msg.countdown_active){
                          countdownActive = received_msg.countdown_active
                          requestAnimationFrame(progressBarCountDown)
                        }
                        if (received_msg.progress_bar_time) {
                            progressStep = 34 / (received_msg.progress_bar_time * 10)
                        } else {
                            progressStep = .1
                        }

                        countdownActive = received_msg.countdown_active
                        setProgressVisibility(received_msg.progress_visible);
                        setHearts(received_msg.hearts);
                    };
                    ws.onclose = function() {
                        messageContainer.innerHTML = "Connection is closed...";
                        console.log("Connection closed. Reconnecting...")
                        setTimeout(function(){
                          WebSocketTest();
                        }, 3000)
                    };
                } else {
                    messageContainer.innerHTML = "WebSocket NOT supported by your Browser!";
                }
            }

            function progressBarCountDown(){
              var progressBar = document.querySelector(".time-left_progress");
              progressValue -= progressStep;
              if(progressValue < 0){
                progressValue = 100;
                try{
                  var id = window.location.search.split("?")[1].split("=")[1]
                  var messageString = "Time end";
                  var message = {message: messageString, id: id};
                  ws.send(JSON.stringify(message));
                }catch(err){}
              }
              if(countdownActive){
                progressBar.style.width = progressValue + '%'
                requestAnimationFrame(progressBarCountDown)
              }
            }

            function setProgressVisibility(progressBarVisible){
              var progressBar = document.querySelector(".time-left");
              if(progressBarVisible){
                progressBar.style.display = 'block';
              }else{
                progressBar.style.display = 'none';
              }
            }

            function setHearts(heartsNumber){
                var hearts = document.querySelectorAll(".heart");
                for(var i = 0; i < hearts.length; i++){
                  hearts[i].style.display = 'inline-block';
                }
                if(hearts.length == heartsNumber){return}
                var diff = hearts.length - heartsNumber;
                for(var i = 0; i < diff; i++){
                  hearts[i].style.display = 'none';
                }
            }

            function sendButton(event){
                buttonId = event.currentTarget.dataset.id
                ws.send("Button clicked:"+buttonId)
            }

            function cretateMessage(messageString, id) {
                
                var message = {message: messageString, id: id};
                return message
            }

            function resetProgress(){
                progressValue = 100;
            }

            document.addEventListener("DOMContentLoaded", function(event) {
              WebSocketTest();
              var progressBar = document.querySelector(".time-left_progress");
              progressBar.addEventListener("webkitTransitionEnd", function(event){
                resetProgress();
                console.log("Reset progress");
                setTimeout(function(){
                  progressBar.style.width = '0%';
                }, 1)
                var id = window.location.search.split("?")[1].split("=")[1]
                var messageString = "Time end; at end of index";
                var message = {message: messageString, id: id};
                ws.send(JSON.stringify(message));
              }, false)
            })
        </script>
    </head>
    <body>
      <div class="screen">
        <div class="hearts">
          <div class="heart"></div>
          <div class="heart"></div>
          <div class="heart"></div>
        </div>
        <div class="message" id="message"div></div>
        <div class="time-left" id="time-left">
          <div class="time-left_progress" id="time-left"></div>
        </div>
      </div>
    </body>
</html>
